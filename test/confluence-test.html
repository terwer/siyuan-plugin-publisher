<!--
  ~            GNU GENERAL PUBLIC LICENSE
  ~               Version 3, 29 June 2007
  ~
  ~  Copyright (C) 2025 Terwer, Inc. <https://terwer.space/>
  ~  Everyone is permitted to copy and distribute verbatim copies
  ~  of this license document, but changing it is not allowed.
  -->

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confluence API æµ‹è¯•å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, textarea, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .inline-group {
            display: flex;
            gap: 10px;
        }
        .inline-group select {
            flex: 1;
        }
        .inline-group button {
            flex-shrink: 0;
        }
        .help-text {
            margin-top: 6px;
            font-size: 12px;
            color: #666;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background-color: #45a049;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .success {
            border-color: #4CAF50;
            background-color: #f0f9f0;
        }
        .error {
            border-color: #f44336;
            background-color: #fff0f0;
        }
        .warning {
            border-color: #ff9800;
            background-color: #fff8f0;
        }
    </style>
</head>
<body>
<h1>ğŸ” Confluence API æµ‹è¯•å·¥å…·</h1>
<p>ç”¨äºæµ‹è¯• Cloudflare Tunnel + Confluence çš„è¿æ¥é—®é¢˜</p>

<div class="form-group">
    <label for="baseUrl">Confluence åœ°å€:</label>
    <input type="text" id="baseUrl" value="https://confluence.ocean-zhc.com.cn" placeholder="https://confluence.your-domain.com">
</div>

<div class="form-group">
    <label for="token">Personal Access Token:</label>
    <input type="password" id="token" placeholder="è¾“å…¥ä½ çš„ Confluence Personal Access Token">
</div>

<div class="form-group">
    <label for="spaceKey">ç©ºé—´ Key (å¯é€‰ï¼Œç”¨äºæµ‹è¯•åˆ›å»ºé¡µé¢):</label>
    <input type="text" id="spaceKey" placeholder="ä¾‹å¦‚: DEV, TECH ç­‰">
</div>

<div class="form-group">
    <label for="parentPageId">çˆ¶é¡µé¢ ID (å¯é€‰):</label>
    <div class="inline-group">
        <select id="parentPageId" disabled>
            <option value="">ä¸é€‰æ‹©çˆ¶é¡µé¢</option>
        </select>
        <button type="button" onclick="loadParentPages()">åˆ·æ–°çˆ¶é¡µé¢</button>
    </div>
    <div class="help-text">å…ˆå¡«å†™ç©ºé—´ Key ååˆ·æ–°ï¼Œä¸‹æ‹‰åˆ—è¡¨ä¼šæ˜¾ç¤ºé¡µé¢æ ‡é¢˜åŠ IDï¼Œä¾‹å¦‚ ocean-zhc+s çš„çŸ¥è¯†åº“ (327683)ã€‚</div>
</div>

<h3>æµ‹è¯•é€‰é¡¹ï¼š</h3>
<button onclick="testGetSpaces()">1. æµ‹è¯•è·å–ç©ºé—´åˆ—è¡¨ (GET)</button>
<button onclick="testCreatePage()">2. æµ‹è¯•åˆ›å»ºé¡µé¢ (POST)</button>
<button onclick="testHeaders()">3. æµ‹è¯•è¯·æ±‚å¤´æ˜¯å¦å®Œæ•´</button>

<div id="result" class="result" style="display: none;"></div>

<script>
    function getConfig(options = {}) {
        const { requireSpaceKey = false, showError = true } = options;
        const baseUrl = document.getElementById('baseUrl').value.trim();
        const token = document.getElementById('token').value.trim();
        const spaceKey = document.getElementById('spaceKey').value.trim();
        const parentPageId = document.getElementById('parentPageId').value.trim();

        if (!baseUrl || !token) {
            if (showError) {
                showResult('è¯·å¡«å†™ Confluence åœ°å€å’Œ Tokenï¼', 'error');
            }
            return null;
        }

        if (requireSpaceKey && !spaceKey) {
            if (showError) {
                showResult('è¯·å¡«å†™ç©ºé—´ Keyï¼', 'error');
            }
            return null;
        }

        return { baseUrl, token, spaceKey, parentPageId };
    }

    function showResult(message, type = 'success') {
        const resultDiv = document.getElementById('result');
        resultDiv.textContent = message;
        resultDiv.className = 'result ' + type;
        resultDiv.style.display = 'block';
    }

    async function testGetSpaces() {
        const config = getConfig();
        if (!config) return;

        showResult('æ­£åœ¨æµ‹è¯•è·å–ç©ºé—´åˆ—è¡¨...', 'warning');

        try {
            const response = await fetch(`${config.baseUrl}/rest/api/space?limit=10`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${config.token}`,
                    'X-Atlassian-Token': 'no-check',
                    'Accept': 'application/json',
                }
            });

            const data = await response.text();
            let result = `çŠ¶æ€ç : ${response.status} ${response.statusText}\n\n`;
            result += `å“åº”å¤´:\n`;
            response.headers.forEach((value, key) => {
                result += `  ${key}: ${value}\n`;
            });
            result += `\nå“åº”ä½“:\n${data}`;

            if (response.ok) {
                showResult('âœ… æˆåŠŸï¼\n\n' + result, 'success');
            } else {
                showResult('âŒ å¤±è´¥ï¼\n\n' + result, 'error');
            }
        } catch (error) {
            showResult(`âŒ è¯·æ±‚å¼‚å¸¸ï¼š\n${error.message}\n\nå¯èƒ½æ˜¯ç½‘ç»œé”™è¯¯æˆ– CORS é—®é¢˜`, 'error');
        }
    }

    async function loadParentPages(showError = true) {
        const parentSelect = document.getElementById('parentPageId');
        const config = getConfig({ requireSpaceKey: true, showError });
        if (!config) {
            parentSelect.innerHTML = '<option value="">ä¸é€‰æ‹©çˆ¶é¡µé¢</option>';
            parentSelect.disabled = true;
            return;
        }

        parentSelect.disabled = true;
        parentSelect.innerHTML = '<option value="">åŠ è½½ä¸­...</option>';

        try {
            const response = await fetch(`${config.baseUrl}/rest/api/content?spaceKey=${encodeURIComponent(config.spaceKey)}&type=page&limit=200&expand=ancestors`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${config.token}`,
                    'X-Atlassian-Token': 'no-check',
                    'Accept': 'application/json',
                }
            });

            if (!response.ok) {
                const text = await response.text();
                throw new Error(`${response.status} ${response.statusText}: ${text}`);
            }

            const data = await response.json();
            const currentValue = config.parentPageId;
            const options = ['<option value="">ä¸é€‰æ‹©çˆ¶é¡µé¢</option>'];
            (data.results || []).forEach((page) => {
                const label = `${page.title} (${page.id})`;
                options.push(`<option value="${page.id}">${label}</option>`);
            });

            parentSelect.innerHTML = options.join('');
            parentSelect.disabled = false;
            if (currentValue) {
                parentSelect.value = currentValue;
                if (parentSelect.value !== currentValue) {
                    parentSelect.value = '';
                }
            }
        } catch (error) {
            parentSelect.innerHTML = '<option value="">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</option>';
            showResult(`âŒ çˆ¶é¡µé¢åŠ è½½å¤±è´¥ï¼š\n${error.message}`, 'error');
        }
    }

    async function testCreatePage() {
        const config = getConfig({ requireSpaceKey: true });
        if (!config) return;

        showResult('æ­£åœ¨æµ‹è¯•åˆ›å»ºé¡µé¢...', 'warning');

        const testData = {
            type: 'page',
            title: `API æµ‹è¯•é¡µé¢ - ${new Date().toISOString()}`,
            space: {
                key: config.spaceKey
            },
            body: {
                storage: {
                    value: '<p>è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•é¡µé¢ï¼Œç”¨äºéªŒè¯ API åŠŸèƒ½ã€‚</p><p>å¦‚æœä½ çœ‹åˆ°è¿™ä¸ªé¡µé¢ï¼Œè¯´æ˜ API è°ƒç”¨æˆåŠŸï¼</p>',
                    representation: 'storage'
                }
            }
        };

        if (config.parentPageId) {
            testData.ancestors = [
                {
                    id: config.parentPageId
                }
            ];
        }

        try {
            const response = await fetch(`${config.baseUrl}/rest/api/content`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${config.token}`,
                    'X-Atlassian-Token': 'no-check',
                    'Accept': 'application/json',
                },
                body: JSON.stringify(testData)
            });

            const data = await response.text();
            let result = `çŠ¶æ€ç : ${response.status} ${response.statusText}\n\n`;
            result += `å“åº”å¤´:\n`;
            response.headers.forEach((value, key) => {
                result += `  ${key}: ${value}\n`;
            });
            result += `\nå“åº”ä½“:\n${data}`;

            if (response.ok) {
                showResult('âœ… æˆåŠŸåˆ›å»ºé¡µé¢ï¼\n\n' + result, 'success');
            } else {
                showResult('âŒ åˆ›å»ºå¤±è´¥ï¼\n\n' + result, 'error');
            }
        } catch (error) {
            showResult(`âŒ è¯·æ±‚å¼‚å¸¸ï¼š\n${error.message}\n\nå¯èƒ½æ˜¯ç½‘ç»œé”™è¯¯æˆ– CORS é—®é¢˜`, 'error');
        }
    }

    async function testHeaders() {
        const config = getConfig();
        if (!config) return;

        showResult('æ­£åœ¨æµ‹è¯•è¯·æ±‚å¤´...', 'warning');

        // ä½¿ç”¨ httpbin.org çš„é•œåƒæœåŠ¡æ¥æŸ¥çœ‹å®é™…å‘é€çš„è¯·æ±‚å¤´
        showResult(`
ğŸ“‹ æ£€æŸ¥æ¸…å•ï¼š

1. æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…· (F12)
2. åˆ‡æ¢åˆ° Network (ç½‘ç»œ) æ ‡ç­¾
3. ç‚¹å‡»ä¸Šé¢çš„ "æµ‹è¯•è·å–ç©ºé—´åˆ—è¡¨" æŒ‰é’®
4. æ‰¾åˆ° /rest/api/space è¯·æ±‚
5. ç‚¹å‡»æŸ¥çœ‹ Headers (è¯·æ±‚å¤´)
6. æ£€æŸ¥ Request Headers ä¸­æ˜¯å¦åŒ…å«ï¼š

   âœ“ Content-Type: application/json
   âœ“ Authorization: Bearer [ä½ çš„token]
   âœ“ X-Atlassian-Token: no-check  â† æœ€å…³é”®ï¼
   âœ“ Accept: application/json

7. å¦‚æœç¼ºå°‘ X-Atlassian-Tokenï¼Œè¯´æ˜è¢« Cloudflare è¿‡æ»¤äº†

ğŸ’¡ è§£å†³æ–¹æ¡ˆï¼š

å¦‚æœ X-Atlassian-Token è¢«è¿‡æ»¤ï¼š

A) åœ¨ Cloudflare æ§åˆ¶å°é…ç½®ï¼š
   1. ç™»å½• Cloudflare Dashboard
   2. é€‰æ‹©ä½ çš„åŸŸå
   3. è¿›å…¥ Rules â†’ Transform Rules â†’ Modify Request Header
   4. æ·»åŠ è§„åˆ™å…è®¸ X-Atlassian-Token é€šè¿‡

B) æˆ–è€…ç›´æ¥ä½¿ç”¨å†…ç½‘åœ°å€ï¼š
   åœ¨æ’ä»¶é…ç½®ä¸­ä½¿ç”¨ Confluence çš„å†…ç½‘åœ°å€
   ä¾‹å¦‚: http://192.168.x.x:8090

C) æˆ–è€…é…ç½® Cloudflare Tunnel å…è®¸æ‰€æœ‰å¤´éƒ¨ï¼š
   åœ¨ cloudflared é…ç½®ä¸­æ·»åŠ  originRequest è®¾ç½®
            `, 'warning');
    }

    document.getElementById('spaceKey').addEventListener('blur', () => {
        if (document.getElementById('spaceKey').value.trim()) {
            loadParentPages(false);
        }
    });
</script>
</body>
</html>
